Workflow of the authentication
===============================

1. The user goes to a page that need authentication
2. The plugin `sessionauthCoordPlugin` checks the authentication
   and a `jHttp401UnauthorizedException` exception is thrown, because
   - there is no authentication workflow that has started
   - or the IDP says that the user is not authenticated.
2. When a `jHttp401UnauthorizedException` exception occurs into the plugin,
   the user is redirected to the login page.
3. The login page is displayed with HTML generated by each identity provider
   into their `IdentityProviderInterface::getHtmlLoginForm()` method.
   This HTML can contain a form or links managed by the module of the idp.
4. The user goes to the authentication process (login/password, CAS, SAML etc..).
   The module of the IDP may redirect the user to an external web site, and
   then redirected to the application after the authentication.
5. After the authentication, if it has succeeded, the idp call `$workflow = jAuthentication::startAuthenticationWorkflow()`.
   It will start a workflow: the user may be forced to go throw several pages,
   in order to complete the authentication. So, after this call, the idp must
   redirect to the url given by `$workflow->getNextAuthenticationUrl()`.
6. When the user is redirected to several pages:
   - At each page, the plugin `sessionauthCoordPlugin` checks the page is a page of
     the workflow. If this is not the case, it redirects the user to the current page
     of the workflow.
   - when the user finish the workflow, it is redirected to the home page or to
     the url given to the workflow by the idp, after creating the workflow.


Workflow of the check of authentication at the session reloading
================================================================

1. The user goes to a page
2. `sessionauthCoordPlugin` load a session object `AuthSessionHandlerInterface`
3. It calls it `hasSessionUser()` method
4. It checks if there is an existing authentication workflow. The user may be redirected
   to a page of the workflow if it is not finished.
4. If there is a session user, it retrieves the identity provider used to authenticate the
   user and calls `IdentityProviderInterface::checkSessionValidity()`. This method
   can throw a `jHttp401UnauthorizedException` exception, if the session is not valid anymore.
5. if there is not a session user, it calls all identity provider with
   `IdentityProviderInterface::checkSessionValidity()`
6. If there is no `jHttp401UnauthorizedException` exception, the page corresponding
   to the current url is displayed.
6. In case of a `jHttp401UnauthorizedException` exception, there is a redirection to
   the page indicated into the configuration, which should be the login page.
   If this exception occurs during a XHR call, most of the time there is no redirection, 
   and an error page is rendered with http error.



Workflow of the logout
======================

1. the user click on the logout button.
2. the corresponding action should call `jAuthentication::signout()`
3. `jAuthentication::signout()` clean the session. It also retrieves the current
   idp, and asks it the url to do the logout.
4. the default action `sign:out` redirect to this url, or if it is not given, to
   the url of the sign in page.


The workflow steps
==================

When an authentication workflow starts, it initializes a number of "steps".
Steps can contain 0 or more page where the user should go, before to be considered
"authenticated".

The steps are:

1. the user account step (named `get_account`): An event is emitted so a module managing accounts can
   give the account object corresponding to the user, if it has one.
2. the create account step (named `create_account`): it is called when there is no account, and if the account
   creation is permitted. An event is emitted so a module managing accounts can give
   the page where to redirect the user, and which shows a form to create the account
   for example.
3. check account step (named `check_account`): An event is emitted to allow some modules
   to check the account, for example, if the account is allowed to access to the application etc.
   Or to load some additional things in session
4. second factor step (named `second_factor`): An event is emitted to allow some modules to give pages
   where the user should go, in order to authenticate against other authentication process,
   like authentication with an encrypted hardware key, an SMS code etc.
5. access validation step (named `access_validation`): An event is emitted to allow some modules to give pages
   where the user should go, in order to finish the process to access to the application.
   It may be a page to get acknowledgment of terms of service for example, or a form to
   force to change the password etc.

All events are named `AuthWorkflowStep`, with a parameter `stepName` indicating the step name.

   